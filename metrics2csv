#!/bin/bash
# Usage:
#
#   metrics2csv test server
#
# Or recursive re-processing of an entire directory tree instead:
#
  #   metrics2csv test server

# Scaffolding for re-testing the import code
function clear {
psql -d results -c "TRUNCATE TABLE test_metrics_data;"
}

function process {
if [ ! -f config ] ; then
  echo Not a test result directory, skipping
fi
source ./config
TEST=$1

if [ -s "meminfo.log" ] ; then
    # Linux
    echo Processing Linux formatted log files
    ../../../csv2gnuplot -i iostat.log -d iostat -s "Device" -t "pgbench disk" --disks=${DISKLIST} -o iostat
    ../../../csv2gnuplot -i vmstat.log -d vmstat -s "cache" -t "pgbench vmstat" -o vmstat
    ../../../dirty-plot < meminfo.log > dirtydata.txt
else
    # Assume Darwin for now, eventually others?
    echo Processing Darwin formatted log files
    ../../../csv2gnuplot -i iostat.log -d iostat -s "KB/t" -t "pgbench disk" -o iostat
    ../../../csv2gnuplot -i vmstat.log -d vmstat -s "wired" -t "pgbench vmstat" -o vmstat
fi

psql -d results -f ../../../export-latency-metric.sql

psql -d results -c "DELETE FROM test_metrics_data WHERE test=${TEST} AND server='${SERVERNAME}'"
psql -d results -c "TRUNCATE TABLE tmp_metric_import;"
psql -d results -c "\copy tmp_metric_import FROM 'latency_metric.csv' WITH CSV HEADER"
psql -d results -c "\copy tmp_metric_import FROM 'vmstat.csv' WITH CSV HEADER"
psql -d results -c "\copy tmp_metric_import FROM 'iostat.csv' WITH CSV HEADER"
if [ -f "meminfo.csv" ] ; then
  psql -d results -c "\copy tmp_metric_import FROM 'meminfo.csv' WITH CSV HEADER"
fi
psql -d results -c "INSERT INTO test_metrics_data (collected,value,metric,test,server) SELECT collected,value,metric,${TEST},'${SERVERNAME}'  FROM tmp_metric_import;"
}

function show {
psql -d results -c "SELECT metric,collected,value FROM test_metrics_data WHERE server='${SERVERNAME}' and test=${TEST} ORDER BY collected,metric LIMIT 10"
}

#
# Recurse import an entire directory tree
#
function reprocess {
shopt -s nullglob
pushd results

for d in *
do
  if [ -d $d ] ; then
    pushd $d
    echo "Server directory $d"

	for f in *
	do
	  if [ -d $f ] ; then
	    pushd $f
	    echo "Result directory $d/$f"
	    process $f
        popd
	  fi
    done

    popd
  fi
done
}

#
# Main
#

if [ "$1" = "recurse" ] ; then
  echo "Recursion mode"
  reprocess

elif [ -n "$2" ] ; then
  # Try to handle being called from test results directory or from
  # toolkit base directory
  if [ ! -f "iostat.log" ] ; then
    pushd results/$2/$1
  fi
  process $1
else
    echo "Usage:  metrics2csv test server."
    echo "Or use 'recurse' from the code directory for automatic mode."
fi
